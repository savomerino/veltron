<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas (Veltron)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .modal { transition: opacity 0.25s ease; }
        .task-card { transition: all 0.2s ease-in-out; }
        .task-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-slate-900">Gestor de Tareas</h1>
            <button id="addTaskBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-sm">
                + Nueva Tarea
            </button>
        </header>

        <main id="taskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </main>
    </div>

    <div id="taskModal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl transform transition-all" id="modal-content">
            <div class="px-6 py-4 border-b">
                <h3 class="text-xl font-semibold" id="modalTitle">Nueva Tarea</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    
                    <div class="mb-4">
                        <label for="title" class="block text-sm font-medium text-slate-700 mb-1">Título</label>
                        <input type="text" id="title" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    
                    <div class="mb-4">
                        <label for="description" class="block text-sm font-medium text-slate-700 mb-1">Descripción</label>
                        <textarea id="description" rows="3" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="assignedTo" class="block text-sm font-medium text-slate-700 mb-1">Asignado a</label>
                            <input type="text" id="assignedTo" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="deadline" class="block text-sm font-medium text-slate-700 mb-1">Fecha Límite</label>
                            <input type="date" id="deadline" class="w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Checklist</label>
                        <div id="checklistContainer" class="space-y-2">
                            </div>
                        <button type="button" id="addChecklistItemBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-semibold">+ Agregar item</button>
                    </div>
                </form>
            </div>
            
            <div class="px-6 py-4 bg-slate-50 flex justify-end space-x-3">
                <button type="button" id="cancelBtn" class="px-4 py-2 bg-white border border-slate-300 rounded-md text-sm font-medium hover:bg-slate-50">Cancelar</button>
                <button type="button" id="saveBtn" class="px-4 py-2 bg-blue-600 border border-transparent rounded-md text-sm font-medium text-white hover:bg-blue-700">Guardar Tarea</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- Selectores del DOM ---
    const taskList = document.getElementById('taskList');
    const modal = document.getElementById('taskModal');
    const modalContent = document.getElementById('modal-content');
    const addTaskBtn = document.getElementById('addTaskBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const addChecklistItemBtn = document.getElementById('addChecklistItemBtn');
    const checklistContainer = document.getElementById('checklistContainer');
    
    // Formulario
    const taskForm = {
        id: document.getElementById('taskId'),
        title: document.getElementById('title'),
        description: document.getElementById('description'),
        assignedTo: document.getElementById('assignedTo'),
        deadline: document.getElementById('deadline'),
    };
    const modalTitle = document.getElementById('modalTitle');

    const API_URL = './api/task.php';

    // --- Funciones de la API ---
    const getTasks = async () => {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Error al cargar las tareas.');
            return await response.json();
        } catch (error) {
            console.error(error);
            taskList.innerHTML = `<p class="text-center text-red-500 col-span-full">${error.message}</p>`;
            return [];
        }
    };

    const saveTask = async (taskData) => {
        const isUpdating = !!taskData.id;
        const url = isUpdating ? `${API_URL}?id=${taskData.id}` : API_URL;
        const method = isUpdating ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(taskData)
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'No se pudo guardar la tarea.');
            }
            return await response.json();
        } catch (error) {
            console.error(error);
            alert(`Error: ${error.message}`);
        }
    };
    
    const deleteTask = async (taskId) => {
        if (!confirm('¿Estás seguro de que quieres eliminar esta tarea?')) return;
        
        try {
             const response = await fetch(`${API_URL}?id=${taskId}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'No se pudo eliminar la tarea.');
            }
            await loadAndRenderTasks();
        } catch (error) {
            console.error(error);
            alert(`Error: ${error.message}`);
        }
    };

    // --- Funciones de Renderizado ---
    const renderTasks = (tasks) => {
        taskList.innerHTML = '';
        if (tasks.length === 0) {
            taskList.innerHTML = `<p class="text-center text-slate-500 col-span-full">No hay tareas. ¡Crea una nueva!</p>`;
            return;
        }

        tasks.forEach(task => {
            const checklistHTML = task.checklist && task.checklist.length > 0
                ? `<ul class="space-y-2 mt-3">
                    ${task.checklist.map(item => `
                        <li class="flex items-center">
                            <input type="checkbox" id="item-${item.id}" ${item.done ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" disabled>
                            <label for="item-${item.id}" class="ml-2 block text-sm ${item.done ? 'text-slate-500 line-through' : ''}">${item.text}</label>
                        </li>
                    `).join('')}
                   </ul>`
                : '<p class="text-sm text-slate-400 mt-3">Sin checklist.</p>';
            
            const taskCard = document.createElement('div');
            taskCard.className = 'task-card bg-white p-5 rounded-lg border border-slate-200 shadow-sm';
            taskCard.innerHTML = `
                <div class="flex justify-between items-start">
                    <h2 class="text-lg font-bold text-slate-800">${task.title}</h2>
                    <span class="text-xs font-semibold px-2 py-1 rounded-full ${task.status === 'pendiente' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${task.status}</span>
                </div>
                <p class="text-sm text-slate-600 mt-2">${task.description || 'Sin descripción.'}</p>
                <div class="text-xs text-slate-500 mt-4 border-t pt-3 flex justify-between">
                    <span>Asignado a: <strong class="font-medium">${task.assigned_to || 'N/A'}</strong></span>
                    <span>Fecha Límite: <strong class="font-medium">${task.deadline || 'N/A'}</strong></span>
                </div>
                ${checklistHTML}
                <div class="mt-4 pt-3 border-t flex justify-end space-x-2">
                    <button class="edit-btn text-sm font-medium text-blue-600 hover:text-blue-800" data-task-id="${task.id}">Editar</button>
                    <button class="delete-btn text-sm font-medium text-red-600 hover:text-red-800" data-task-id="${task.id}">Eliminar</button>
                </div>
            `;
            taskList.appendChild(taskCard);
        });
        
        // Adjuntar eventos a los nuevos botones
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditTask));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteTask));
    };

    const loadAndRenderTasks = async () => {
        const tasks = await getTasks();
        renderTasks(tasks);
    };

    // --- Funciones del Modal y Formulario ---
    const openModal = (task = null) => {
        taskForm.id.value = task ? task.id : '';
        taskForm.title.value = task ? task.title : '';
        taskForm.description.value = task ? task.description : '';
        taskForm.assignedTo.value = task ? task.assigned_to : '';
        taskForm.deadline.value = task ? task.deadline : '';
        modalTitle.textContent = task ? 'Editar Tarea' : 'Nueva Tarea';

        // Limpiar y poblar checklist
        checklistContainer.innerHTML = '';
        if (task && task.checklist) {
            task.checklist.forEach(item => addChecklistItemToDOM(item));
        }
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10); // Para la animación
    };

    const closeModal = () => {
        modal.classList.add('opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    };

    const addChecklistItemToDOM = (item = {}) => {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        div.innerHTML = `
            <input type="checkbox" class="checklist-item-done h-4 w-4 rounded border-gray-300" ${item.done ? 'checked' : ''}>
            <input type="text" class="checklist-item-text flex-grow px-2 py-1 border border-slate-300 rounded-md text-sm" value="${item.text || ''}" placeholder="Descripción del item...">
            <input type="hidden" class="checklist-item-id" value="${item.id || ''}">
            <button type="button" class="remove-checklist-item text-red-500 hover:text-red-700">&times;</button>
        `;
        checklistContainer.appendChild(div);
        
        div.querySelector('.remove-checklist-item').addEventListener('click', () => div.remove());
    };

    // --- Manejadores de Eventos ---
    const handleSave = async () => {
        if (!taskForm.title.value.trim()) {
            alert('El título es obligatorio.');
            return;
        }

        const checklist = Array.from(checklistContainer.children).map(div => ({
            id: div.querySelector('.checklist-item-id').value,
            text: div.querySelector('.checklist-item-text').value,
            done: div.querySelector('.checklist-item-done').checked
        })).filter(item => item.text.trim() !== '');

        const taskData = {
            id: taskForm.id.value,
            title: taskForm.title.value,
            description: taskForm.description.value,
            assigned_to: taskForm.assignedTo.value,
            deadline: taskForm.deadline.value,
            checklist: checklist
        };

        await saveTask(taskData);
        closeModal();
        await loadAndRenderTasks();
    };

    async function handleEditTask(event) {
        const taskId = this.dataset.taskId;
        const tasks = await getTasks();
        const taskToEdit = tasks.find(t => t.id == taskId);
        if (taskToEdit) {
            openModal(taskToEdit);
        }
    }
    
    function handleDeleteTask(event) {
        const taskId = this.dataset.taskId;
        deleteTask(taskId);
    }
    
    // Asignación de eventos iniciales
    addTaskBtn.addEventListener('click', () => openModal());
    cancelBtn.addEventListener('click', closeModal);
    saveBtn.addEventListener('click', handleSave);
    addChecklistItemBtn.addEventListener('click', () => addChecklistItemToDOM());
    
    // Cierre de modal al hacer clic fuera del contenido
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // --- Carga Inicial ---
    loadAndRenderTasks();
});
</script>
</body>
</html>