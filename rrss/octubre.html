<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Interactivo de Contenidos - VELTRON</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.5rem;
        }
        .day-header {
            text-align: center;
            font-weight: 600;
            padding: 0.5rem;
            color: #475569;
        }
        .day {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            min-height: 140px;
            padding: 0.5rem;
            background-color: #ffffff;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        .day.drag-over {
            background-color: #dbeafe; /* Blue 100 */
            border-style: dashed;
            border-color: #3b82f6; /* Blue 500 */
        }
        .day-content { flex-grow: 1; }
        .day-number { font-weight: 600; color: #1e293b; }
        .day.other-month { background-color: #f1f5f9; }
        .day.other-month .day-number { color: #94a3b8; }
        
        .post {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            margin-top: 0.25rem;
            cursor: grab;
            transition: background-color 0.2s ease;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .post-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-grow: 1;
        }
        .post.completed .post-title {
            text-decoration: line-through;
            opacity: 0.6;
        }
        .post.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .post-Reel { background-color: #e0e7ff; color: #3730a3; border-left: 3px solid #4f46e5; }
        .post-Story { background-color: #fef3c7; color: #92400e; border-left: 3px solid #f59e0b; }
        .post-Imagen { background-color: #d1fae5; color: #065f46; border-left: 3px solid #10b981; }
        .post-Carrusel { background-color: #fee2e2; color: #991b1b; border-left: 3px solid #ef4444; }
        
        .add-post-btn {
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-top: auto;
        }
        .day:hover .add-post-btn { opacity: 1; }

        .modal-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }
        .modal-textarea { min-height: 100px; }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Planificador de Contenidos</h1>
                <p class="text-lg text-gray-600">Arrastra y suelta las ideas para reorganizar tu calendario.</p>
            </div>
            <a href="index.html" class="bg-slate-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-slate-700 transition-colors inline-block mt-4 sm:mt-0">
                ← Volver al Plan Estratégico
            </a>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-slate-100 transition-colors">&lt;</button>
                <h2 id="current-month" class="text-xl sm:text-2xl font-bold text-slate-800"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-slate-100 transition-colors">&gt;</button>
            </div>
            <div class="calendar-grid">
                <div class="day-header">LUN</div>
                <div class="day-header">MAR</div>
                <div class="day-header">MIÉ</div>
                <div class="day-header">JUE</div>
                <div class="day-header">VIE</div>
                <div class="day-header">SÁB</div>
                <div class="day-header">DOM</div>
            </div>
            <div id="calendar-body" class="calendar-grid"></div>
        </div>
        
        <!-- Brainstorming Section -->
        <div id="brainstorming-section" class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-slate-800">Ideas Fuera del Calendario</h2>
                <button id="add-brainstorm-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm">+ Proponer Idea</button>
            </div>
            <p class="text-gray-600 mb-4">Este es un espacio para que el equipo deje propuestas. ¡Arrastra una idea al calendario para programarla!</p>
            <div id="brainstorming-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[100px] bg-slate-50 p-4 rounded-lg">
                <!-- Brainstormed ideas will be injected here -->
            </div>
        </div>

        <!-- Progress Bar Section -->
        <div id="progress-section" class="bg-white rounded-lg shadow-md p-4 sm:p-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Progreso del Mes</h2>
            <div class="flex justify-between items-center mb-1 text-sm font-medium">
                <span class="text-gray-600">Tareas Completadas</span>
                <span id="progress-text" class="text-slate-800 font-semibold">0 / 0 (0%)</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-4">
                <div id="progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

    </div>

    <!-- Modal for adding/editing posts -->
    <div id="post-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full relative">
            <h3 id="modal-title" class="text-xl font-bold mb-4">Agregar Idea</h3>
            <form id="post-form">
                <input type="hidden" id="modal-context">
                <input type="hidden" id="post-date">
                <input type="hidden" id="post-id">
                <div class="space-y-4">
                    <div>
                        <label for="post-type" class="block text-sm font-medium text-gray-700">Tipo de Contenido</label>
                        <select id="post-type" class="modal-input" required>
                            <option value="Reel">Reel</option>
                            <option value="Story">Story</option>
                            <option value="Imagen">Imagen</option>
                            <option value="Carrusel">Carrusel</option>
                        </select>
                    </div>
                    <div>
                        <label for="post-title" class="block text-sm font-medium text-gray-700">Título</label>
                        <input type="text" id="post-title" class="modal-input" required>
                    </div>
                    <div>
                        <label for="post-idea" class="block text-sm font-medium text-gray-700">Idea Principal</label>
                        <input type="text" id="post-idea" class="modal-input">
                    </div>
                    <div>
                        <label for="post-development" class="block text-sm font-medium text-gray-700">Desarrollo</label>
                        <textarea id="post-development" class="modal-input modal-textarea"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" id="delete-post-btn" class="text-sm text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    <div>
                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-slate-200 rounded-md text-sm font-medium hover:bg-slate-300">Cancelar</button>
                        <button type="submit" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const calendarBody = document.getElementById('calendar-body');
            const currentMonthEl = document.getElementById('current-month');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const modal = document.getElementById('post-modal');
            const modalTitle = document.getElementById('modal-title');
            const form = document.getElementById('post-form');
            const cancelBtn = document.getElementById('cancel-btn');
            const deleteBtn = document.getElementById('delete-post-btn');
            const addBrainstormBtn = document.getElementById('add-brainstorm-btn');
            const brainstormingList = document.getElementById('brainstorming-list');

            const API_URL = 'api/'; // Directorio de la API de PHP

            let currentDate = new Date('2025-10-01T12:00:00');
            let savedPosts = {};
            let brainstormingIdeas = [];

            // --- API Helper Functions ---
            const apiFetch = async (endpoint, method = 'GET', body = null) => {
                try {
                    const options = {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                    };
                    if (body) {
                        options.body = JSON.stringify(body);
                    }
                    const response = await fetch(API_URL + endpoint, options);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Error ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error en la API:', error);
                    alert('Error de comunicación con el servidor: ' + error.message);
                    return null;
                }
            };

            const apiGetPosts = async () => {
                const data = await apiFetch('get_posts.php');
                if (data) {
                    savedPosts = data.calendarPosts || {};
                    brainstormingIdeas = data.brainstormingIdeas || [];
                    renderAll();
                }
            };

            const apiSavePost = async (postData, date = null) => {
                const payload = { ...postData, date };
                const result = await apiFetch('save_post.php', 'POST', payload);
                if (result && result.success) {
                    // Actualizamos el ID si es un post nuevo
                    if (!postData.id) {
                        postData.id = result.id;
                    }
                    return true;
                }
                return false;
            };

            const apiDeletePost = async (id) => {
                const result = await apiFetch('delete_post.php', 'POST', { id });
                return result && result.success;
            };
            
            const createPostElement = (post, date = null) => {
                const postEl = document.createElement('div');
                postEl.className = `post post-${post.type} ${post.completed ? 'completed' : ''}`;
                postEl.draggable = true;
                postEl.dataset.postId = post.id;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = post.completed;
                checkbox.className = 'form-checkbox h-4 w-4 rounded text-blue-600 transition duration-150 ease-in-out';
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePostCompleted(post, date);
                });
                postEl.appendChild(checkbox);

                const titleEl = document.createElement('span');
                titleEl.className = 'post-title';
                titleEl.textContent = post.title;
                postEl.appendChild(titleEl);

                const context = date ? 'calendar' : 'brainstorm';
                postEl.addEventListener('click', () => openModal(date, post.id, context));
                postEl.addEventListener('dragstart', handleDragStart);
                postEl.addEventListener('dragend', handleDragEnd);

                if (date) { // It's a calendar post
                    postEl.dataset.originalDate = date;
                    postEl.dataset.context = 'calendar';
                } else { // It's a brainstorming post
                    postEl.dataset.context = 'brainstorm';
                }
                
                return postEl;
            };

            const renderAll = () => {
                renderCalendar();
                renderBrainstormingList();
                updateProgressBar();
            }

            const renderCalendar = () => {
                calendarBody.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                currentMonthEl.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long' }).toUpperCase()} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1);
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;

                for (let i = 0; i < startDayOfWeek; i++) {
                    calendarBody.appendChild(document.createElement('div')).className = 'day other-month';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day';
                    dayEl.dataset.date = dateStr;
                    dayEl.innerHTML = `<div class="day-content"><span class="day-number">${i}</span><div id="posts-${dateStr}" class="mt-1 space-y-1"></div></div><button class="add-post-btn text-blue-500 hover:text-blue-700 text-xs font-bold py-1 text-center w-full">+ Agregar Idea</button>`;
                    calendarBody.appendChild(dayEl);
                    
                    dayEl.querySelector('.add-post-btn').addEventListener('click', () => openModal(dateStr, null, 'calendar'));
                    
                    if (savedPosts[dateStr]) {
                        const postsContainer = dayEl.querySelector(`#posts-${dateStr}`);
                        savedPosts[dateStr].forEach(post => {
                            postsContainer.appendChild(createPostElement(post, dateStr));
                        });
                    }
                    dayEl.addEventListener('dragover', handleDragOver);
                    dayEl.addEventListener('dragenter', handleDragEnter);
                    dayEl.addEventListener('dragleave', handleDragLeave);
                    dayEl.addEventListener('drop', handleDrop);
                }
            };

            const renderBrainstormingList = () => {
                brainstormingList.innerHTML = '';
                if(brainstormingIdeas.length === 0) {
                    brainstormingList.innerHTML = `<p class="text-slate-400 italic col-span-full text-center">No hay ideas propuestas. ¡Sé el primero!</p>`;
                } else {
                    brainstormingIdeas.forEach(post => {
                        brainstormingList.appendChild(createPostElement(post));
                    });
                }
            };
            
            const updateProgressBar = () => {
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                let totalTasks = 0;
                let completedTasks = 0;

                Object.values(savedPosts).forEach(dayPosts => {
                    totalTasks += dayPosts.length;
                    completedTasks += dayPosts.filter(p => p.completed).length;
                });

                const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${completedTasks} / ${totalTasks} (${percentage}%)`;
            };

            const togglePostCompleted = async (post, date) => {
                post.completed = !post.completed;
                const success = await apiSavePost(post, date);
                if (success) {
                    renderAll();
                } else { // Revert on failure
                    post.completed = !post.completed;
                }
            };

            function handleDragStart(e) {
                e.target.classList.add('dragging');
                const data = {
                    postId: e.target.dataset.postId,
                    originalDate: e.target.dataset.originalDate,
                    context: e.target.dataset.context,
                };
                e.dataTransfer.setData('application/json', JSON.stringify(data));
            }
            function handleDragEnd(e) { e.target.classList.remove('dragging'); }
            function handleDragOver(e) { e.preventDefault(); }
            function handleDragEnter(e) { if (e.target.classList.contains('day')) e.target.classList.add('drag-over'); }
            function handleDragLeave(e) { if (e.target.classList.contains('day')) e.target.classList.remove('drag-over'); }
            
            async function handleDrop(e) {
                e.preventDefault();
                const dropZone = e.target.closest('.day');
                if (!dropZone || dropZone.classList.contains('other-month')) return;
                
                dropZone.classList.remove('drag-over');
                const data = JSON.parse(e.dataTransfer.getData('application/json'));
                const newDate = dropZone.dataset.date;

                let postToMove;
                let originalPostIndex;

                if (data.context === 'calendar') {
                    if (data.originalDate === newDate) return;
                    originalPostIndex = savedPosts[data.originalDate].findIndex(p => p.id == data.postId);
                    postToMove = savedPosts[data.originalDate][originalPostIndex];
                } else { // context === 'brainstorm'
                    originalPostIndex = brainstormingIdeas.findIndex(p => p.id == data.postId);
                    postToMove = brainstormingIdeas[originalPostIndex];
                }

                // Optimistic update on the frontend
                if (data.context === 'calendar') {
                    savedPosts[data.originalDate].splice(originalPostIndex, 1);
                    if (savedPosts[data.originalDate].length === 0) delete savedPosts[data.originalDate];
                } else {
                    brainstormingIdeas.splice(originalPostIndex, 1);
                }
                if (!savedPosts[newDate]) savedPosts[newDate] = [];
                savedPosts[newDate].push(postToMove);
                renderAll();

                // Save change to backend
                const success = await apiSavePost(postToMove, newDate);
                if (!success) {
                    // If backend fails, revert the change and re-render
                    await apiGetPosts();
                    alert("Error al mover la idea. Se recargarán los datos.");
                }
            }

            const openModal = (date, postId = null, context = 'calendar') => {
                form.reset();
                deleteBtn.classList.add('hidden');
                document.getElementById('modal-context').value = context;

                if (context === 'calendar') {
                    document.getElementById('post-date').value = date;
                    if (postId) {
                        modalTitle.textContent = 'Editar Idea del Calendario';
                        const post = savedPosts[date].find(p => p.id == postId);
                        Object.keys(post).forEach(key => {
                            const el = document.getElementById(`post-${key}`);
                            if(el) el.value = post[key];
                        });
                        deleteBtn.classList.remove('hidden');
                    } else {
                        modalTitle.textContent = 'Agregar Idea al Calendario';
                        document.getElementById('post-id').value = '';
                    }
                } else { // Brainstorming
                     if (postId) {
                        modalTitle.textContent = 'Editar Propuesta';
                        const post = brainstormingIdeas.find(p => p.id == postId);
                         Object.keys(post).forEach(key => {
                            const el = document.getElementById(`post-${key}`);
                            if(el) el.value = post[key];
                        });
                        deleteBtn.classList.remove('hidden');
                    } else {
                        modalTitle.textContent = 'Proponer Nueva Idea';
                        document.getElementById('post-id').value = '';
                    }
                }
                modal.classList.remove('hidden');
            };
            
            const closeModal = () => modal.classList.add('hidden');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const context = document.getElementById('modal-context').value;
                const id = document.getElementById('post-id').value;
                const date = document.getElementById('post-date').value;

                const postData = {
                    id: id ? parseInt(id) : null,
                    type: document.getElementById('post-type').value,
                    title: document.getElementById('post-title').value,
                    idea: document.getElementById('post-idea').value,
                    development: document.getElementById('post-development').value,
                    completed: false, // Default for new, preserved for existing
                };

                // Preserve completed state if editing
                if (id) {
                    let existingPost;
                    if (context === 'calendar') {
                        existingPost = savedPosts[date].find(p => p.id == id);
                    } else {
                        existingPost = brainstormingIdeas.find(p => p.id == id);
                    }
                    if(existingPost) postData.completed = existingPost.completed;
                }

                const postDate = context === 'calendar' ? date : null;
                const success = await apiSavePost(postData, postDate);

                if (success) {
                    await apiGetPosts(); // Refresh all data from DB
                    closeModal();
                }
            });

            deleteBtn.addEventListener('click', async () => {
                const id = document.getElementById('post-id').value;
                if (!id || !confirm('¿Estás seguro de que quieres eliminar esta idea?')) {
                    return;
                }
                
                const success = await apiDeletePost(id);
                if (success) {
                    await apiGetPosts(); // Refresh all data from DB
                    closeModal();
                }
            });

            addBrainstormBtn.addEventListener('click', () => openModal(null, null, 'brainstorm'));
            cancelBtn.addEventListener('click', closeModal);
            prevMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });
            nextMonthBtn.addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Initial Load
            apiGetPosts();
        });
    </script>
</body>
</html>

